stages:
  - install
  - validate
  - test
  - build
  - deploy

# Cache node_modules để tăng tốc
cache:
  paths:
    - node_modules/

# Job 1: Install dependencies
install_dependencies:
  stage: install
  tags:
    - shell
  script:
    - Write-Host "Installing dependencies..." -ForegroundColor Cyan
    - node --version
    - npm --version
    - npm ci --prefer-offline
    - Write-Host "Dependencies installed successfully!" -ForegroundColor Green
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

# Job 2: Code quality check
code_quality:
  stage: validate
  tags:
    - shell
  dependencies:
    - install_dependencies
  script:
    - Write-Host "Checking code quality..." -ForegroundColor Cyan
    - node --check src/server.mjs
    - Write-Host "Code quality check passed!" -ForegroundColor Green

# Job 3: Database validation
validate_database:
  stage: validate
  tags:
    - shell
  dependencies:
    - install_dependencies
  script:
    - Write-Host "Validating database configuration..." -ForegroundColor Cyan
    - npx sequelize-cli db:migrate:status
    - Write-Host "Database validation passed!" -ForegroundColor Green
  allow_failure: true

# Job 4: Run tests (optional, skip if no tests)
run_tests:
  stage: test
  tags:
    - shell
  dependencies:
    - install_dependencies
  script:
    - Write-Host "Running tests..." -ForegroundColor Cyan
    - Write-Host "No tests configured yet - Skipping" -ForegroundColor Yellow
    - Write-Host "Tests completed!" -ForegroundColor Green
  allow_failure: true

# Job 5: Build application
build_app:
  stage: build
  tags:
    - shell
  dependencies:
    - install_dependencies
  script:
    - Write-Host "Building application..." -ForegroundColor Cyan
    - Write-Host "Checking all source files..." -ForegroundColor Yellow
    - Get-ChildItem -Path src -Filter *.mjs -Recurse | ForEach-Object { node --check $_.FullName }
    - Write-Host "Build completed successfully!" -ForegroundColor Green
  artifacts:
    paths:
      - src/
      - node_modules/
    expire_in: 1 day

# Job 6: Deploy to staging (manual trigger)
deploy_staging:
  stage: deploy
  tags:
    - shell
  dependencies:
    - build_app
  script:
    - Write-Host "Deploying to staging environment..." -ForegroundColor Cyan
    - Write-Host "Starting server in background..." -ForegroundColor Yellow
    - Write-Host "Deployment to staging completed!" -ForegroundColor Green
  when: manual
  only:
    - main
